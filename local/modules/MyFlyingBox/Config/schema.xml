<?xml version="1.0" encoding="UTF-8"?>
<database defaultIdMethod="native" name="TheliaMain"
          xmlns="http://www.propelorm.org/schema/1.1"
          xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
          xsi:schemaLocation="http://www.propelorm.org/schema/1.1 http://www.propelorm.org/schema/1.1/database.xsd">

    <!-- Services de transport disponibles (transporteurs LCE) -->
    <table name="myflyingbox_service" namespace="MyFlyingBox\Model" phpName="MyFlyingBoxService">
        <column name="id" primaryKey="true" autoIncrement="true" type="INTEGER"/>
        <column name="carrier_code" type="VARCHAR" size="100" required="true"/>
        <column name="code" type="VARCHAR" size="100" required="true"/>
        <column name="name" type="VARCHAR" size="255" required="true"/>
        <column name="pickup_available" type="BOOLEAN" default="false"/>
        <column name="dropoff_available" type="BOOLEAN" default="false"/>
        <column name="relay_delivery" type="BOOLEAN" default="false"/>
        <column name="tracking_url" type="VARCHAR" size="500"/>
        <column name="delivery_delay" type="VARCHAR" size="100" description="Displayed delivery delay (ex: 24-48h, 3-5 days)"/>
        <column name="active" type="BOOLEAN" default="true"/>
        <column name="created_at" type="TIMESTAMP"/>
        <column name="updated_at" type="TIMESTAMP"/>
        <unique name="myflyingbox_service_code_unique">
            <unique-column name="code"/>
        </unique>
        <behavior name="timestampable"/>
    </table>

    <!-- Devis de transport (cache des quotes API) -->
    <table name="myflyingbox_quote" namespace="MyFlyingBox\Model" phpName="MyFlyingBoxQuote">
        <column name="id" primaryKey="true" autoIncrement="true" type="INTEGER"/>
        <column name="cart_id" type="INTEGER" required="true"/>
        <column name="address_id" type="INTEGER"/>
        <column name="api_quote_uuid" type="VARCHAR" size="255"/>
        <column name="created_at" type="TIMESTAMP"/>
        <column name="updated_at" type="TIMESTAMP"/>
        <foreign-key foreignTable="cart" name="fk_myflyingbox_quote_cart" onDelete="CASCADE">
            <reference local="cart_id" foreign="id"/>
        </foreign-key>
        <foreign-key foreignTable="address" name="fk_myflyingbox_quote_address" onDelete="SET NULL">
            <reference local="address_id" foreign="id"/>
        </foreign-key>
        <behavior name="timestampable"/>
    </table>

    <!-- Offres de prix par devis -->
    <table name="myflyingbox_offer" namespace="MyFlyingBox\Model" phpName="MyFlyingBoxOffer">
        <column name="id" primaryKey="true" autoIncrement="true" type="INTEGER"/>
        <column name="quote_id" type="INTEGER" required="true"/>
        <column name="service_id" type="INTEGER" required="true"/>
        <column name="api_offer_uuid" type="VARCHAR" size="255"/>
        <column name="lce_product_code" type="VARCHAR" size="100"/>
        <column name="base_price_in_cents" type="INTEGER"/>
        <column name="total_price_in_cents" type="INTEGER"/>
        <column name="insurance_price_in_cents" type="INTEGER"/>
        <column name="currency" type="VARCHAR" size="3" default="EUR"/>
        <column name="delivery_days" type="INTEGER"/>
        <column name="created_at" type="TIMESTAMP"/>
        <column name="updated_at" type="TIMESTAMP"/>
        <foreign-key foreignTable="myflyingbox_quote" name="fk_myflyingbox_offer_quote" onDelete="CASCADE">
            <reference local="quote_id" foreign="id"/>
        </foreign-key>
        <foreign-key foreignTable="myflyingbox_service" name="fk_myflyingbox_offer_service" onDelete="CASCADE">
            <reference local="service_id" foreign="id"/>
        </foreign-key>
        <behavior name="timestampable"/>
    </table>

    <!-- Expeditions -->
    <table name="myflyingbox_shipment" namespace="MyFlyingBox\Model" phpName="MyFlyingBoxShipment">
        <column name="id" primaryKey="true" autoIncrement="true" type="INTEGER"/>
        <column name="order_id" type="INTEGER" required="true"/>
        <column name="service_id" type="INTEGER"/>
        <column name="api_quote_uuid" type="VARCHAR" size="255"/>
        <column name="api_offer_uuid" type="VARCHAR" size="255"/>
        <column name="api_order_uuid" type="VARCHAR" size="255"/>
        <column name="collection_date" type="DATE"/>
        <column name="relay_delivery_code" type="VARCHAR" size="50"/>
        <!-- Expediteur -->
        <column name="shipper_name" type="VARCHAR" size="255"/>
        <column name="shipper_company" type="VARCHAR" size="255"/>
        <column name="shipper_street" type="VARCHAR" size="500"/>
        <column name="shipper_city" type="VARCHAR" size="255"/>
        <column name="shipper_postal_code" type="VARCHAR" size="20"/>
        <column name="shipper_country" type="VARCHAR" size="2"/>
        <column name="shipper_phone" type="VARCHAR" size="50"/>
        <column name="shipper_email" type="VARCHAR" size="255"/>
        <!-- Destinataire -->
        <column name="recipient_name" type="VARCHAR" size="255"/>
        <column name="recipient_company" type="VARCHAR" size="255"/>
        <column name="recipient_street" type="VARCHAR" size="500"/>
        <column name="recipient_city" type="VARCHAR" size="255"/>
        <column name="recipient_postal_code" type="VARCHAR" size="20"/>
        <column name="recipient_country" type="VARCHAR" size="2"/>
        <column name="recipient_phone" type="VARCHAR" size="50"/>
        <column name="recipient_email" type="VARCHAR" size="255"/>
        <!-- Statut -->
        <column name="status" type="VARCHAR" size="50" default="pending"/>
        <column name="is_return" type="BOOLEAN" default="false"/>
        <column name="date_booking" type="TIMESTAMP"/>
        <column name="created_at" type="TIMESTAMP"/>
        <column name="updated_at" type="TIMESTAMP"/>
        <foreign-key foreignTable="order" name="fk_myflyingbox_shipment_order" onDelete="CASCADE">
            <reference local="order_id" foreign="id"/>
        </foreign-key>
        <foreign-key foreignTable="myflyingbox_service" name="fk_myflyingbox_shipment_service" onDelete="SET NULL">
            <reference local="service_id" foreign="id"/>
        </foreign-key>
        <behavior name="timestampable"/>
    </table>

    <!-- Colis d'une expedition -->
    <table name="myflyingbox_parcel" namespace="MyFlyingBox\Model" phpName="MyFlyingBoxParcel">
        <column name="id" primaryKey="true" autoIncrement="true" type="INTEGER"/>
        <column name="shipment_id" type="INTEGER" required="true"/>
        <column name="length" type="INTEGER" description="Length in cm"/>
        <column name="width" type="INTEGER" description="Width in cm"/>
        <column name="height" type="INTEGER" description="Height in cm"/>
        <column name="weight" type="DECIMAL" size="10" scale="3" description="Weight in kg"/>
        <column name="shipper_reference" type="VARCHAR" size="100"/>
        <column name="recipient_reference" type="VARCHAR" size="100"/>
        <column name="customer_reference" type="VARCHAR" size="100"/>
        <column name="value" type="INTEGER" description="Value in cents"/>
        <column name="currency" type="VARCHAR" size="3" default="EUR"/>
        <column name="description" type="VARCHAR" size="500"/>
        <column name="tracking_number" type="VARCHAR" size="100"/>
        <column name="label_url" type="VARCHAR" size="500"/>
        <column name="created_at" type="TIMESTAMP"/>
        <column name="updated_at" type="TIMESTAMP"/>
        <foreign-key foreignTable="myflyingbox_shipment" name="fk_myflyingbox_parcel_shipment" onDelete="CASCADE">
            <reference local="shipment_id" foreign="id"/>
        </foreign-key>
        <behavior name="timestampable"/>
    </table>

    <!-- Table de correspondance poids vers dimensions -->
    <table name="myflyingbox_dimension" namespace="MyFlyingBox\Model" phpName="MyFlyingBoxDimension">
        <column name="id" primaryKey="true" autoIncrement="true" type="INTEGER"/>
        <column name="weight_from" type="DECIMAL" size="10" scale="3" required="true"/>
        <column name="weight_to" type="DECIMAL" size="10" scale="3" required="true"/>
        <column name="length" type="INTEGER" required="true"/>
        <column name="width" type="INTEGER" required="true"/>
        <column name="height" type="INTEGER" required="true"/>
        <column name="created_at" type="TIMESTAMP"/>
        <column name="updated_at" type="TIMESTAMP"/>
        <behavior name="timestampable"/>
    </table>

    <!-- Evenements de suivi d'expedition -->
    <table name="myflyingbox_shipment_event" namespace="MyFlyingBox\Model" phpName="MyFlyingBoxShipmentEvent">
        <column name="id" primaryKey="true" autoIncrement="true" type="INTEGER"/>
        <column name="shipment_id" type="INTEGER" required="true"/>
        <column name="parcel_id" type="INTEGER"/>
        <column name="event_code" type="VARCHAR" size="50" required="true"/>
        <column name="event_label" type="VARCHAR" size="255"/>
        <column name="event_date" type="TIMESTAMP"/>
        <column name="location" type="VARCHAR" size="255"/>
        <column name="created_at" type="TIMESTAMP"/>
        <foreign-key foreignTable="myflyingbox_shipment" name="fk_myflyingbox_event_shipment" onDelete="CASCADE">
            <reference local="shipment_id" foreign="id"/>
        </foreign-key>
        <foreign-key foreignTable="myflyingbox_parcel" name="fk_myflyingbox_event_parcel" onDelete="CASCADE">
            <reference local="parcel_id" foreign="id"/>
        </foreign-key>
    </table>

    <!-- Point relais selectionne par panier -->
    <table name="myflyingbox_cart_relay" namespace="MyFlyingBox\Model" phpName="MyFlyingBoxCartRelay">
        <column name="id" primaryKey="true" autoIncrement="true" type="INTEGER"/>
        <column name="cart_id" type="INTEGER" required="true"/>
        <column name="relay_code" type="VARCHAR" size="50" required="true"/>
        <column name="relay_name" type="VARCHAR" size="255"/>
        <column name="relay_street" type="VARCHAR" size="500"/>
        <column name="relay_city" type="VARCHAR" size="255"/>
        <column name="relay_postal_code" type="VARCHAR" size="20"/>
        <column name="relay_country" type="VARCHAR" size="2"/>
        <column name="created_at" type="TIMESTAMP"/>
        <column name="updated_at" type="TIMESTAMP"/>
        <foreign-key foreignTable="cart" name="fk_myflyingbox_cart_relay_cart" onDelete="CASCADE">
            <reference local="cart_id" foreign="id"/>
        </foreign-key>
        <unique name="myflyingbox_cart_relay_unique">
            <unique-column name="cart_id"/>
        </unique>
        <behavior name="timestampable"/>
    </table>

</database>
