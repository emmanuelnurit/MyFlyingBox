{* MyFlyingBox - Order Shipment JavaScript *}
<script>
$(function() {
    var orderId = {$order_id};
    var $container = $('.mfb-shipment-container[data-order-id="' + orderId + '"]');
    var $messages = $('#mfb-shipment-messages');

    // Translations for modals
    var MFB_ORDER_TRANSLATIONS = {
        cancel: '{intl l="Cancel" d="myflyingbox"|escape:"javascript"}',
        confirm: '{intl l="Confirm" d="myflyingbox"|escape:"javascript"}'
    };

    // Modern confirm modal (replaces native confirm())
    function showConfirmModal(title, message, onConfirm, options) {
        options = options || {};
        var type = options.type || 'warning';
        var confirmText = options.confirmText || MFB_ORDER_TRANSLATIONS.confirm;
        var confirmClass = options.confirmClass || 'btn-danger';

        var iconMap = {
            warning: 'exclamation-triangle',
            danger: 'times-circle',
            info: 'info-circle'
        };
        var colorMap = {
            warning: { bg: '#fff3cd', border: '#ffc107', icon: '#664d03', text: '#664d03' },
            danger: { bg: '#f8d7da', border: '#dc3545', icon: '#842029', text: '#842029' },
            info: { bg: '#cff4fc', border: '#0dcaf0', icon: '#055160', text: '#055160' }
        };
        var colors = colorMap[type] || colorMap.warning;
        var icon = iconMap[type] || 'exclamation-triangle';

        var modalId = 'mfb-confirm-modal-' + Date.now();
        var $modal = $('<div class="modal fade" id="' + modalId + '" tabindex="-1" role="dialog">' +
            '<div class="modal-dialog modal-dialog-centered" role="document" style="max-width: 420px;">' +
                '<div class="modal-content" style="border-radius: 12px; overflow: hidden; border: none; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">' +
                    '<div class="modal-body text-center" style="padding: 2rem 2rem 1.5rem 2rem; background: ' + colors.bg + ';">' +
                        '<div style="margin-bottom: 1rem;">' +
                            '<i class="fa fa-' + icon + '" style="font-size: 3rem; color: ' + colors.icon + ';"></i>' +
                        '</div>' +
                        '<h5 style="margin: 0 0 0.75rem 0; font-weight: 600; color: ' + colors.text + ';">' + title + '</h5>' +
                        '<p style="margin: 0; color: ' + colors.text + '; opacity: 0.9; font-size: 0.95rem;">' + message + '</p>' +
                    '</div>' +
                    '<div class="modal-footer" style="padding: 1rem 2rem; background: #fff; border-top: 1px solid ' + colors.border + '40; justify-content: center; gap: 1rem;">' +
                        '<button type="button" class="btn btn-secondary" data-dismiss="modal" style="padding: 0.5rem 1.5rem; font-weight: 500;">' + MFB_ORDER_TRANSLATIONS.cancel + '</button>' +
                        '<button type="button" class="btn ' + confirmClass + '" id="mfb-confirm-action-btn" style="padding: 0.5rem 1.5rem; font-weight: 500;">' + confirmText + '</button>' +
                    '</div>' +
                '</div>' +
            '</div>' +
        '</div>');

        $('body').append($modal);

        $modal.find('#mfb-confirm-action-btn').on('click', function() {
            $modal.modal('hide');
            if (onConfirm) onConfirm();
        });

        $modal.on('hidden.bs.modal', function() {
            $modal.remove();
        });

        $modal.modal('show');
    }

    function showMessage(type, message) {
        $messages.html('<div class="alert alert-' + type + ' alert-dismissible">' +
            '<button type="button" class="close" data-dismiss="alert">&times;</button>' +
            message + '</div>');
    }

    function showLoading($btn) {
        $btn.prop('disabled', true).data('original-html', $btn.html());
        $btn.html('<i class="fa fa-spinner fa-spin"></i> {intl l="Please wait..." d="myflyingbox"|escape:"javascript"}');
    }

    function hideLoading($btn) {
        $btn.prop('disabled', false).html($btn.data('original-html'));
    }

    // Create shipment form
    $('#mfb-create-shipment-form').on('submit', function(e) {
        e.preventDefault();

        var $form = $(this);
        var $btn = $form.find('button[type="submit"]');
        var serviceId = $('#mfb-service-select').val();
        var collectionDate = $form.find('input[name="collection_date"]').val();

        if (!serviceId) {
            showMessage('warning', '{intl l="Please select a carrier service" d="myflyingbox"|escape:"javascript"}');
            return;
        }

        showLoading($btn);

        $.ajax({
            url: '{url path="/admin/module/myflyingbox/shipment/create"}',
            method: 'POST',
            data: {
                order_id: orderId,
                service_id: serviceId,
                collection_date: collectionDate
            },
            dataType: 'json'
        })
        .done(function(response) {
            if (response.success) {
                showMessage('success', '{intl l="Shipment created successfully!" d="myflyingbox"|escape:"javascript"}');
                // Reload the tab content
                setTimeout(function() {
                    location.reload();
                }, 1000);
            } else {
                showMessage('danger', response.message || '{intl l="An error occurred" d="myflyingbox"|escape:"javascript"}');
            }
        })
        .fail(function(xhr) {
            var msg = '{intl l="An error occurred" d="myflyingbox"|escape:"javascript"}';
            if (xhr.responseJSON && xhr.responseJSON.message) {
                msg = xhr.responseJSON.message;
            }
            showMessage('danger', msg);
        })
        .always(function() {
            hideLoading($btn);
        });
    });

    // Book shipment
    $container.on('click', '.mfb-action-book', function() {
        var $btn = $(this);
        var shipmentId = $btn.data('shipment-id');

        showConfirmModal(
            '{intl l="Book Shipment" d="myflyingbox"|escape:"javascript"}',
            '{intl l="Are you sure you want to book this shipment? This action cannot be undone." d="myflyingbox"|escape:"javascript"}',
            function() {
                showLoading($btn);

                $.ajax({
                    url: '{url path="/admin/module/myflyingbox/shipment/book"}',
                    method: 'POST',
                    data: { shipment_id: shipmentId },
                    dataType: 'json'
                })
                .done(function(response) {
                    if (response.success) {
                        showMessage('success', '{intl l="Shipment booked successfully!" d="myflyingbox"|escape:"javascript"}');
                        setTimeout(function() {
                            location.reload();
                        }, 1000);
                    } else {
                        showMessage('danger', response.message || '{intl l="Failed to book shipment" d="myflyingbox"|escape:"javascript"}');
                    }
                })
                .fail(function(xhr) {
                    var msg = '{intl l="An error occurred" d="myflyingbox"|escape:"javascript"}';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        msg = xhr.responseJSON.message;
                    }
                    showMessage('danger', msg);
                })
                .always(function() {
                    hideLoading($btn);
                });
            },
            {
                type: 'info',
                confirmText: '{intl l="Book" d="myflyingbox"|escape:"javascript"}',
                confirmClass: 'btn-primary'
            }
        );
    });

    // Download labels
    $container.on('click', '.mfb-action-labels', function() {
        var $btn = $(this);
        var shipmentId = $btn.data('shipment-id');

        showLoading($btn);

        // Use the proxy route to download the label PDF
        var downloadUrl = '{url path="/admin/module/myflyingbox/shipment/download-label"}?shipment_id=' + shipmentId;
        window.open(downloadUrl, '_blank');

        hideLoading($btn);
    });

    // Update tracking
    $container.on('click', '.mfb-action-tracking', function() {
        var $btn = $(this);
        var shipmentId = $btn.data('shipment-id');

        showLoading($btn);

        $.ajax({
            url: '{url path="/admin/module/myflyingbox/shipment/sync-tracking"}',
            method: 'POST',
            data: { shipment_id: shipmentId },
            dataType: 'json'
        })
        .done(function(response) {
            if (response.success) {
                showMessage('success', '{intl l="Tracking updated successfully!" d="myflyingbox"|escape:"javascript"}');
                loadTrackingTimeline(shipmentId);
                if (response.status_changed) {
                    setTimeout(function() {
                        location.reload();
                    }, 1500);
                }
            } else {
                showMessage('info', response.message || '{intl l="No tracking updates available" d="myflyingbox"|escape:"javascript"}');
            }
        })
        .fail(function() {
            showMessage('danger', '{intl l="Failed to update tracking" d="myflyingbox"|escape:"javascript"}');
        })
        .always(function() {
            hideLoading($btn);
        });
    });

    // Cancel shipment
    $container.on('click', '.mfb-action-cancel', function() {
        var $btn = $(this);
        var shipmentId = $btn.data('shipment-id');

        showConfirmModal(
            '{intl l="Cancel Shipment" d="myflyingbox"|escape:"javascript"}',
            '{intl l="Are you sure you want to cancel this shipment?" d="myflyingbox"|escape:"javascript"}',
            function() {
                showLoading($btn);

                $.ajax({
                    url: '{url path="/admin/module/myflyingbox/shipment/cancel"}',
                    method: 'POST',
                    data: { shipment_id: shipmentId },
                    dataType: 'json'
                })
                .done(function(response) {
                    if (response.success) {
                        showMessage('success', '{intl l="Shipment cancelled" d="myflyingbox"|escape:"javascript"}');
                        setTimeout(function() {
                            location.reload();
                        }, 1000);
                    } else {
                        showMessage('danger', response.message || '{intl l="Failed to cancel shipment" d="myflyingbox"|escape:"javascript"}');
                    }
                })
                .fail(function() {
                    showMessage('danger', '{intl l="An error occurred" d="myflyingbox"|escape:"javascript"}');
                })
                .always(function() {
                    hideLoading($btn);
                });
            },
            {
                type: 'danger',
                confirmText: '{intl l="Cancel Shipment" d="myflyingbox"|escape:"javascript"}',
                confirmClass: 'btn-danger'
            }
        );
    });

    // Load tracking timeline on page load
    function loadTrackingTimeline(shipmentId) {
        var $timeline = $('#mfb-tracking-timeline');
        if ($timeline.length === 0) return;

        $.ajax({
            url: '{url path="/admin/module/myflyingbox/shipment/tracking"}',
            method: 'GET',
            data: { order_id: orderId },
            dataType: 'json'
        })
        .done(function(response) {
            if (response.success && response.tracking && response.tracking.length > 0) {
                var html = '';
                var hasContent = false;

                response.tracking.forEach(function(shipment) {
                    // Display shipment-level events first
                    if (shipment.events && shipment.events.length > 0) {
                        hasContent = true;
                        html += '<div class="shipment-events" style="margin-bottom: 15px;">';
                        html += '<h5><i class="fa fa-truck"></i> {intl l="Shipment History" d="myflyingbox"|escape:"javascript"}</h5>';
                        html += '<ul class="list-unstyled">';
                        shipment.events.forEach(function(event) {
                            var statusClass = 'label-default';
                            if (event.status === 'BOOKED') statusClass = 'label-info';
                            else if (event.status === 'CREATED') statusClass = 'label-primary';
                            else if (event.status === 'CANCELLED') statusClass = 'label-danger';
                            else if (event.status === 'STATUS_CHANGE') statusClass = 'label-warning';

                            html += '<li style="margin-bottom: 5px;">';
                            html += '<small class="text-muted">' + (event.date || '') + '</small> ';
                            html += '<span class="label ' + statusClass + '">' + (event.status || '') + '</span> ';
                            html += event.message || '';
                            if (event.location) {
                                html += ' <small class="text-muted">(' + event.location + ')</small>';
                            }
                            html += '</li>';
                        });
                        html += '</ul>';
                        html += '</div>';
                    }

                    // Display parcel tracking events
                    shipment.parcels.forEach(function(parcel) {
                        if (parcel.tracking_number) {
                            hasContent = true;
                            html += '<div class="parcel-events" style="margin-bottom: 15px;">';
                            html += '<h5><i class="fa fa-cube"></i> ' + parcel.tracking_number;
                            if (parcel.tracking_url) {
                                html += ' <a href="' + parcel.tracking_url + '" target="_blank" class="btn btn-xs btn-link"><i class="fa fa-external-link"></i></a>';
                            }
                            html += '</h5>';
                            if (parcel.events && parcel.events.length > 0) {
                                html += '<ul class="list-unstyled">';
                                parcel.events.forEach(function(event) {
                                    html += '<li style="margin-bottom: 5px;">';
                                    html += '<small class="text-muted">' + (event.date || '') + '</small> ';
                                    html += '<span class="label label-default">' + (event.status || '') + '</span> ';
                                    html += event.message || '';
                                    if (event.location) {
                                        html += ' <small class="text-muted">(' + event.location + ')</small>';
                                    }
                                    html += '</li>';
                                });
                                html += '</ul>';
                            } else {
                                html += '<p class="text-muted">{intl l="No tracking events yet" d="myflyingbox"|escape:"javascript"}</p>';
                            }
                            html += '</div>';
                        }
                    });
                });

                if (hasContent) {
                    $timeline.html(html);
                } else {
                    $timeline.html('<p class="text-muted"><i class="fa fa-info-circle"></i> {intl l="No history events yet" d="myflyingbox"|escape:"javascript"}</p>');
                }
            } else {
                $timeline.html('<p class="text-muted"><i class="fa fa-info-circle"></i> {intl l="No history events yet" d="myflyingbox"|escape:"javascript"}</p>');
            }
        })
        .fail(function(xhr, status, error) {
            console.error('MFB Tracking error:', status, error, xhr.responseText);
            $timeline.html('<p class="text-danger"><i class="fa fa-exclamation-triangle"></i> {intl l="Failed to load history" d="myflyingbox"|escape:"javascript"}</p>');
        });
    }

    // Load tracking on page load if timeline exists
    if ($('#mfb-tracking-timeline').length > 0) {
        loadTrackingTimeline();
    }

    // Create return shipment
    $('#mfb-confirm-return').on('click', function() {
        var $btn = $(this);
        var $form = $('#mfb-create-return-form');
        var shipmentId = $form.find('input[name="shipment_id"]').val();
        var serviceId = $('#mfb-return-service-select').val();

        showLoading($btn);

        $.ajax({
            url: '{url path="/admin/module/myflyingbox/shipment/create-return"}',
            method: 'POST',
            data: {
                shipment_id: shipmentId,
                service_id: serviceId || ''
            },
            dataType: 'json'
        })
        .done(function(response) {
            if (response.success) {
                $('#mfb-return-modal').modal('hide');
                showMessage('success', '{intl l="Return shipment created successfully!" d="myflyingbox"|escape:"javascript"}');
                setTimeout(function() {
                    location.reload();
                }, 1000);
            } else {
                showMessage('danger', response.message || "{intl l='Failed to create return shipment' d='myflyingbox'|escape:'javascript'}");
            }
        })
        .fail(function(xhr) {
            var msg = '{intl l="An error occurred" d="myflyingbox"|escape:"javascript"}';
            if (xhr.responseJSON && xhr.responseJSON.message) {
                msg = xhr.responseJSON.message;
            }
            showMessage('danger', msg);
        })
        .always(function() {
            hideLoading($btn);
        });
    });

    // Reset modal when closed
    $('#mfb-return-modal').on('hidden.bs.modal', function() {
        $('#mfb-return-service-select').val('');
    });
});
</script>

<style>
.mfb-shipment-container .timeline {
    list-style: none;
    padding-left: 20px;
    border-left: 2px solid #ddd;
}
.mfb-shipment-container .timeline-item {
    position: relative;
    padding: 10px 0 10px 20px;
}
.mfb-shipment-container .timeline-item:before {
    content: '';
    position: absolute;
    left: -7px;
    top: 15px;
    width: 12px;
    height: 12px;
    background: #428bca;
    border-radius: 50%;
}

/* Modern Confirm Modal Styles */
.modal-dialog-centered {
    display: flex;
    align-items: center;
    min-height: calc(100% - 1rem);
}
@media (min-width: 576px) {
    .modal-dialog-centered {
        min-height: calc(100% - 3.5rem);
    }
}

/* Modal animation */
.modal.fade .modal-dialog {
    transform: scale(0.9);
    opacity: 0;
    transition: transform 0.2s ease-out, opacity 0.2s ease-out;
}
.modal.show .modal-dialog {
    transform: scale(1);
    opacity: 1;
}

/* Modal footer button gap */
.modal-footer {
    display: flex;
    gap: 0.75rem;
}

/* Button hover effects */
.modal-footer .btn {
    transition: all 0.2s ease;
}
.modal-footer .btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}
.modal-footer .btn-danger:hover {
    background-color: #bb2d3b;
    border-color: #b02a37;
}
.modal-footer .btn-primary:hover {
    background-color: #0b5ed7;
    border-color: #0a58ca;
}
</style>
