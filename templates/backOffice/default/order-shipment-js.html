{* MyFlyingBox - Order Shipment JavaScript *}
<script>
(function() {
    // Vérifier que jQuery est disponible
    if (typeof jQuery === 'undefined' && typeof $ === 'undefined') {
        console.warn('MyFlyingBox: jQuery is required for shipment management. Some features may not work.');
        return;
    }

    // Utiliser jQuery ou $ selon disponibilité
    var $ = window.jQuery || window.$;

    $(function() {
    var orderId = {$order_id};
    var $container = $('.mfb-shipment-container[data-order-id="' + orderId + '"]');
    var $messages = $('#mfb-shipment-messages');

    // Translations for modals and statuses
    var MFB_ORDER_TRANSLATIONS = {
        cancel: '{intl l="Cancel" d="myflyingbox"|escape:"javascript"}',
        confirm: '{intl l="Confirm" d="myflyingbox"|escape:"javascript"}',
        // Status translations
        statuses: {
            'CREATED': '{intl l="Created" d="myflyingbox"|escape:"javascript"}',
            'BOOKED': '{intl l="Booked" d="myflyingbox"|escape:"javascript"}',
            'SHIPPED': '{intl l="Shipped" d="myflyingbox"|escape:"javascript"}',
            'DELIVERED': '{intl l="Delivered" d="myflyingbox"|escape:"javascript"}',
            'CANCELLED': '{intl l="Cancelled" d="myflyingbox"|escape:"javascript"}',
            'STATUS_CHANGE': '{intl l="Status change" d="myflyingbox"|escape:"javascript"}',
            'PENDING': '{intl l="Pending" d="myflyingbox"|escape:"javascript"}'
        }
    };

    // Helper to translate status
    function translateStatus(status) {
        return MFB_ORDER_TRANSLATIONS.statuses[status] || status;
    }

    // Modern confirm modal (replaces native confirm())
    function showConfirmModal(title, message, onConfirm, options) {
        options = options || {};
        var type = options.type || 'warning';
        var confirmText = options.confirmText || MFB_ORDER_TRANSLATIONS.confirm;
        var confirmClass = options.confirmClass || 'btn-danger';

        var iconMap = {
            warning: 'exclamation-triangle',
            danger: 'times-circle',
            info: 'info-circle'
        };
        var colorMap = {
            warning: { bg: '#fff3cd', border: '#ffc107', icon: '#664d03', text: '#664d03' },
            danger: { bg: '#f8d7da', border: '#dc3545', icon: '#842029', text: '#842029' },
            info: { bg: '#cff4fc', border: '#0dcaf0', icon: '#055160', text: '#055160' }
        };
        var colors = colorMap[type] || colorMap.warning;
        var icon = iconMap[type] || 'exclamation-triangle';

        var modalId = 'mfb-confirm-modal-' + Date.now();
        var $modal = $('<div class="modal fade" id="' + modalId + '" tabindex="-1" role="dialog">' +
            '<div class="modal-dialog modal-dialog-centered" role="document" style="max-width: 420px;">' +
                '<div class="modal-content" style="border-radius: 12px; overflow: hidden; border: none; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">' +
                    '<div class="modal-body text-center" style="padding: 2rem 2rem 1.5rem 2rem; background: ' + colors.bg + ';">' +
                        '<div style="margin-bottom: 1rem;">' +
                            '<i class="fa fa-' + icon + '" style="font-size: 3rem; color: ' + colors.icon + ';"></i>' +
                        '</div>' +
                        '<h5 style="margin: 0 0 0.75rem 0; font-weight: 600; color: ' + colors.text + ';">' + title + '</h5>' +
                        '<p style="margin: 0; color: ' + colors.text + '; opacity: 0.9; font-size: 0.95rem;">' + message + '</p>' +
                    '</div>' +
                    '<div class="modal-footer" style="padding: 1rem 2rem; background: #fff; border-top: 1px solid ' + colors.border + '40; justify-content: center; gap: 1rem;">' +
                        '<button type="button" class="btn btn-secondary" data-dismiss="modal" style="padding: 0.5rem 1.5rem; font-weight: 500;">' + MFB_ORDER_TRANSLATIONS.cancel + '</button>' +
                        '<button type="button" class="btn ' + confirmClass + '" id="mfb-confirm-action-btn" style="padding: 0.5rem 1.5rem; font-weight: 500;">' + confirmText + '</button>' +
                    '</div>' +
                '</div>' +
            '</div>' +
        '</div>');

        $('body').append($modal);

        $modal.find('#mfb-confirm-action-btn').on('click', function() {
            $modal.modal('hide');
            if (onConfirm) onConfirm();
        });

        $modal.on('hidden.bs.modal', function() {
            $modal.remove();
        });

        $modal.modal('show');
    }

    function showMessage(type, message) {
        $messages.html('<div class="alert alert-' + type + ' alert-dismissible">' +
            '<button type="button" class="close" data-dismiss="alert">&times;</button>' +
            message + '</div>');
    }

    function showLoading($btn) {
        $btn.prop('disabled', true).data('original-html', $btn.html());
        $btn.html('<i class="fa fa-spinner fa-spin"></i> {intl l="Please wait..." d="myflyingbox"|escape:"javascript"}');
    }

    function hideLoading($btn) {
        $btn.prop('disabled', false).html($btn.data('original-html'));
    }

    // Create shipment form
    $('#mfb-create-shipment-form').on('submit', function(e) {
        e.preventDefault();

        var $form = $(this);
        var $btn = $form.find('button[type="submit"]');
        var serviceId = $('#mfb-service-select').val();
        var collectionDate = $form.find('input[name="collection_date"]').val();

        if (!serviceId) {
            showMessage('warning', '{intl l="Please select a carrier service" d="myflyingbox"|escape:"javascript"}');
            return;
        }

        showLoading($btn);

        $.ajax({
            url: '{url path="/admin/module/myflyingbox/shipment/create"}',
            method: 'POST',
            data: {
                order_id: orderId,
                service_id: serviceId,
                collection_date: collectionDate
            },
            dataType: 'json'
        })
        .done(function(response) {
            if (response.success) {
                showMessage('success', '{intl l="Shipment created successfully!" d="myflyingbox"|escape:"javascript"}');
                // Reload the tab content
                setTimeout(function() {
                    location.reload();
                }, 1000);
            } else {
                showMessage('danger', response.message || '{intl l="An error occurred" d="myflyingbox"|escape:"javascript"}');
            }
        })
        .fail(function(xhr) {
            var msg = '{intl l="An error occurred" d="myflyingbox"|escape:"javascript"}';
            if (xhr.responseJSON && xhr.responseJSON.message) {
                msg = xhr.responseJSON.message;
            }
            showMessage('danger', msg);
        })
        .always(function() {
            hideLoading($btn);
        });
    });

    // Book shipment
    $container.on('click', '.mfb-action-book', function() {
        var $btn = $(this);
        var shipmentId = $btn.data('shipment-id');

showConfirmModal(
            '{intl l="Book Shipment" d="myflyingbox"|escape:"javascript"}',
            '{intl l="Are you sure you want to book this shipment? This action cannot be undone." d="myflyingbox"|escape:"javascript"}',
            function() {
                showLoading($btn);

                $.ajax({
                    url: '{url path="/admin/module/myflyingbox/shipment/book"}',
                    method: 'POST',
                    data: { shipment_id: shipmentId },
                    dataType: 'json'
                })
                .done(function(response) {
                    if (response.success) {
                        showMessage('success', '{intl l="Shipment booked successfully!" d="myflyingbox"|escape:"javascript"}');
                        setTimeout(function() {
                            location.reload();
                        }, 1000);
                    } else {
                        showMessage('danger', response.message || '{intl l="Failed to book shipment" d="myflyingbox"|escape:"javascript"}');
                    }
                })
                .fail(function(xhr) {
                    var msg = '{intl l="An error occurred" d="myflyingbox"|escape:"javascript"}';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        msg = xhr.responseJSON.message;
                    }
                    showMessage('danger', msg);
                })
                .always(function() {
                    hideLoading($btn);
                });
            },
            {
                type: 'info',
                confirmText: '{intl l="Book" d="myflyingbox"|escape:"javascript"}',
                confirmClass: 'btn-primary'
            }
        );
    });

    // Download labels
    $container.on('click', '.mfb-action-labels', function() {
        var $btn = $(this);
        var shipmentId = $btn.data('shipment-id');

        showLoading($btn);

        // Use the proxy route to download the label PDF
        var downloadUrl = '{url path="/admin/module/myflyingbox/shipment/download-label"}?shipment_id=' + shipmentId;
        window.open(downloadUrl, '_blank');

        hideLoading($btn);
    });

    // Update tracking
    $container.on('click', '.mfb-action-tracking', function() {
        var $btn = $(this);
        var shipmentId = $btn.data('shipment-id');

        showLoading($btn);

        $.ajax({
            url: '{url path="/admin/module/myflyingbox/shipment/sync-tracking"}',
            method: 'POST',
            data: { shipment_id: shipmentId },
            dataType: 'json'
        })
        .done(function(response) {
            if (response.success) {
                showMessage('success', '{intl l="Tracking updated successfully!" d="myflyingbox"|escape:"javascript"}');
                loadTrackingTimeline(shipmentId);
                if (response.status_changed) {
                    setTimeout(function() {
                        location.reload();
                    }, 1500);
                }
            } else {
                showMessage('info', response.message || '{intl l="No tracking updates available" d="myflyingbox"|escape:"javascript"}');
            }
        })
        .fail(function() {
            showMessage('danger', '{intl l="Failed to update tracking" d="myflyingbox"|escape:"javascript"}');
        })
        .always(function() {
            hideLoading($btn);
        });
    });

    // Cancel shipment
    $container.on('click', '.mfb-action-cancel', function() {
        var $btn = $(this);
        var shipmentId = $btn.data('shipment-id');

showConfirmModal(
            '{intl l="Cancel Shipment" d="myflyingbox"|escape:"javascript"}',
            '{intl l="Are you sure you want to cancel this shipment?" d="myflyingbox"|escape:"javascript"}',
            function() {
                showLoading($btn);

                $.ajax({
                    url: '{url path="/admin/module/myflyingbox/shipment/cancel"}',
                    method: 'POST',
                    data: { shipment_id: shipmentId },
                    dataType: 'json'
                })
                .done(function(response) {
                    if (response.success) {
                        showMessage('success', '{intl l="Shipment cancelled" d="myflyingbox"|escape:"javascript"}');
                        setTimeout(function() {
                            location.reload();
                        }, 1000);
                    } else {
                        showMessage('danger', response.message || '{intl l="Failed to cancel shipment" d="myflyingbox"|escape:"javascript"}');
                    }
                })
                .fail(function() {
                    showMessage('danger', '{intl l="An error occurred" d="myflyingbox"|escape:"javascript"}');
                })
                .always(function() {
                    hideLoading($btn);
                });
            },
            {
                type: 'danger',
                confirmText: '{intl l="Cancel Shipment" d="myflyingbox"|escape:"javascript"}',
                confirmClass: 'btn-danger'
            }
        );
    });

    // Load tracking timeline on page load
    function loadTrackingTimeline(shipmentId) {
        var $timeline = $('#mfb-tracking-timeline');
        if ($timeline.length === 0) return;

        $.ajax({
            url: '{url path="/admin/module/myflyingbox/shipment/tracking"}',
            method: 'GET',
            data: { order_id: orderId },
            dataType: 'json'
        })
        .done(function(response) {
            if (response.success && response.tracking && response.tracking.length > 0) {
                var html = '';
                var hasContent = false;

                // Helper function to get icon and status class based on event status
                function getEventStyle(status) {
                    var styles = {
                        'DELIVERED': { icon: 'fa-check', statusClass: 'status-delivered' },
                        'IN_TRANSIT': { icon: 'fa-truck', statusClass: 'status-shipped' },
                        'SHIPPED': { icon: 'fa-truck', statusClass: 'status-shipped' },
                        'BOOKED': { icon: 'fa-bookmark', statusClass: 'status-booked' },
                        'CREATED': { icon: 'fa-plus-circle', statusClass: 'status-created' },
                        'CANCELLED': { icon: 'fa-times', statusClass: 'status-cancelled' },
                        'STATUS_CHANGE': { icon: 'fa-refresh', statusClass: 'status-change' },
                        'OUT_FOR_DELIVERY': { icon: 'fa-truck', statusClass: 'status-shipped' },
                        'PICKED_UP': { icon: 'fa-cube', statusClass: 'status-shipped' }
                    };
                    return styles[status] || { icon: 'fa-circle', statusClass: '' };
                }

                response.tracking.forEach(function(shipment) {
                    // Display shipment-level events first
                    if (shipment.events && shipment.events.length > 0) {
                        hasContent = true;
                        html += '<div class="mfb-history-section" style="margin-bottom: 1.25rem;">';
                        html += '<div class="mfb-history-section-header" style="font-weight: 600; font-size: 0.875rem; color: #475569; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">';
                        html += '<i class="fa fa-truck"></i> {intl l="Shipment History" d="myflyingbox"|escape:"javascript"}';
                        html += '</div>';
                        html += '<div class="mfb-history-list">';
                        shipment.events.forEach(function(event) {
                            var style = getEventStyle(event.status);
                            html += '<div class="mfb-history-item ' + style.statusClass + '">';
                            html += '<div class="mfb-history-icon"><i class="fa ' + style.icon + '"></i></div>';
                            html += '<div class="mfb-history-content">';
                            html += '<div class="mfb-history-title">' + translateStatus(event.status || '') + '</div>';
                            if (event.message || event.location) {
                                html += '<div class="mfb-history-description">';
                                html += event.message || '';
                                if (event.location) {
                                    html += (event.message ? ' - ' : '') + event.location;
                                }
                                html += '</div>';
                            }
                            html += '</div>';
                            html += '<div class="mfb-history-date">' + (event.date || '') + '</div>';
                            html += '</div>';
                        });
                        html += '</div>';
                        html += '</div>';
                    }

                    // Display parcel tracking events
                    shipment.parcels.forEach(function(parcel) {
                        if (parcel.tracking_number) {
                            hasContent = true;
                            html += '<div class="mfb-history-section" style="margin-bottom: 1.25rem;">';
                            html += '<div class="mfb-history-section-header" style="font-weight: 600; font-size: 0.875rem; color: #475569; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">';
                            html += '<i class="fa fa-cube"></i> ' + parcel.tracking_number;
                            if (parcel.tracking_url) {
                                html += ' <a href="' + parcel.tracking_url + '" target="_blank" style="color: #3b82f6; font-size: 0.75rem;"><i class="fa fa-external-link"></i></a>';
                            }
                            html += '</div>';
                            if (parcel.events && parcel.events.length > 0) {
                                html += '<div class="mfb-history-list">';
                                parcel.events.forEach(function(event) {
                                    var style = getEventStyle(event.status);
                                    html += '<div class="mfb-history-item ' + style.statusClass + '">';
                                    html += '<div class="mfb-history-icon"><i class="fa ' + style.icon + '"></i></div>';
                                    html += '<div class="mfb-history-content">';
                                    html += '<div class="mfb-history-title">' + translateStatus(event.status || '') + '</div>';
                                    if (event.message || event.location) {
                                        html += '<div class="mfb-history-description">';
                                        html += event.message || '';
                                        if (event.location) {
                                            html += (event.message ? ' - ' : '') + event.location;
                                        }
                                        html += '</div>';
                                    }
                                    html += '</div>';
                                    html += '<div class="mfb-history-date">' + (event.date || '') + '</div>';
                                    html += '</div>';
                                });
                                html += '</div>';
                            } else {
                                html += '<p class="text-muted" style="font-size: 0.875rem; margin: 0;"><i class="fa fa-info-circle"></i> {intl l="No tracking events yet" d="myflyingbox"|escape:"javascript"}</p>';
                            }
                            html += '</div>';
                        }
                    });
                });

                if (hasContent) {
                    $timeline.html(html);
                } else {
                    $timeline.html('<p class="text-muted" style="font-size: 0.875rem;"><i class="fa fa-info-circle"></i> {intl l="No history events yet" d="myflyingbox"|escape:"javascript"}</p>');
                }
            } else {
                $timeline.html('<p class="text-muted" style="font-size: 0.875rem;"><i class="fa fa-info-circle"></i> {intl l="No history events yet" d="myflyingbox"|escape:"javascript"}</p>');
            }
        })
        .fail(function(xhr, status, error) {
            console.error('MFB Tracking error:', status, error, xhr.responseText);
            $timeline.html('<p class="text-danger"><i class="fa fa-exclamation-triangle"></i> {intl l="Failed to load history" d="myflyingbox"|escape:"javascript"}</p>');
        });
    }

    // Load tracking on page load if timeline exists
    if ($('#mfb-tracking-timeline').length > 0) {
        loadTrackingTimeline();
    }

    // Create return shipment
    $('#mfb-confirm-return').on('click', function() {
        var $btn = $(this);
        var $form = $('#mfb-create-return-form');
        var shipmentId = $form.find('input[name="shipment_id"]').val();
        var serviceId = $('#mfb-return-service-select').val();

        showLoading($btn);

        $.ajax({
            url: '{url path="/admin/module/myflyingbox/shipment/create-return"}',
            method: 'POST',
            data: {
                shipment_id: shipmentId,
                service_id: serviceId || ''
            },
            dataType: 'json'
        })
        .done(function(response) {
            if (response.success) {
                $('#mfb-return-modal').modal('hide');
                showMessage('success', '{intl l="Return shipment created successfully!" d="myflyingbox"|escape:"javascript"}');
                setTimeout(function() {
                    location.reload();
                }, 1000);
            } else {
                showMessage('danger', response.message || "{intl l='Failed to create return shipment' d='myflyingbox'|escape:'javascript'}");
            }
        })
        .fail(function(xhr) {
            var msg = '{intl l="An error occurred" d="myflyingbox"|escape:"javascript"}';
            if (xhr.responseJSON && xhr.responseJSON.message) {
                msg = xhr.responseJSON.message;
            }
            showMessage('danger', msg);
        })
        .always(function() {
            hideLoading($btn);
        });
    });

    // Reset modal when closed
    $('#mfb-return-modal').on('hidden.bs.modal', function() {
        $('#mfb-return-service-select').val('');
    });
    });
})();
</script>

<style>
.mfb-shipment-container {
    margin-top: 1.5rem;
}

.mfb-shipment-container .timeline {
    list-style: none;
    padding-left: 20px;
    border-left: 2px solid #ddd;
}
.mfb-shipment-container .timeline-item {
    position: relative;
    padding: 10px 0 10px 20px;
}
.mfb-shipment-container .timeline-item:before {
    content: '';
    position: absolute;
    left: -7px;
    top: 15px;
    width: 12px;
    height: 12px;
    background: #428bca;
    border-radius: 50%;
}

/* Modern Confirm Modal Styles - Bootstrap 3 compatible */
.modal-dialog-centered {
    display: flex;
    align-items: center;
    min-height: calc(100% - 60px);
    margin: 30px auto;
}

/* Modal animation - Bootstrap 3 uses .in instead of .show */
.modal.fade .modal-dialog {
    transform: scale(0.9);
    opacity: 0;
    transition: transform 0.2s ease-out, opacity 0.2s ease-out;
}
.modal.in .modal-dialog {
    transform: scale(1);
    opacity: 1;
}

/* Modal footer button gap */
.modal-footer {
    display: flex;
    gap: 0.75rem;
}

/* Button hover effects */
.modal-footer .btn {
    transition: all 0.2s ease;
}
.modal-footer .btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}
.modal-footer .btn-danger:hover {
    background-color: #bb2d3b;
    border-color: #b02a37;
}
.modal-footer .btn-primary:hover {
    background-color: #0b5ed7;
    border-color: #0a58ca;
}

/* ========================================
   MFB Shipment Info - Modern Key-Value Style
   ======================================== */

.mfb-info-list {
    display: flex;
    flex-direction: column;
    gap: 0;
}

.mfb-info-row {
    display: flex;
    align-items: flex-start;
    gap: 1rem;
    padding: 0.625rem 0;
    border-bottom: 1px solid #e2e8f0;
}

.mfb-info-row:last-child {
    border-bottom: none;
    padding-bottom: 0;
}

.mfb-info-row:first-child {
    padding-top: 0;
}

.mfb-info-label {
    flex: 0 0 130px;
    font-weight: 600;
    color: #64748b;
    font-size: 0.875rem;
    text-align: left;
    padding-top: 0.125rem;
}

.mfb-info-value {
    flex: 1;
    color: #1e293b;
    font-size: 0.9375rem;
    line-height: 1.5;
    min-width: 0;
}

/* Carrier display */
.mfb-carrier-display {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    flex-wrap: nowrap;
}

.mfb-carrier-display img {
    height: 22px;
    width: auto;
    max-width: 55px;
    object-fit: contain;
    flex-shrink: 0;
}

.mfb-carrier-display .mfb-service-name {
    color: #475569;
}

/* API UUID monospace */
.mfb-info-value code {
    font-size: 0.8125rem;
    background: #f1f5f9;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    word-break: break-all;
}

/* Relay point block */
.mfb-relay-block {
    margin: 0;
    padding: 0.75rem 1rem;
    background: #f0f7ff;
    border: 1px solid #b8daff;
    border-radius: 6px;
}

/* ========================================
   MFB Envelope Header (Postal Style)
   ======================================== */

.mfb-envelope-header {
    display: flex;
    justify-content: center;
    align-items: stretch;
    gap: 2rem;
    padding: 1.5rem 2rem;
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    margin-bottom: 1.5rem;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
}

.mfb-envelope-logo {
    flex: 0 0 auto;
    display: flex;
    align-items: center;
    justify-content: center;
    padding-right: 2rem;
    border-right: 2px dashed #cbd5e1;
}

.mfb-envelope-logo .mfb-logo {
    height: 45px;
    width: auto;
    object-fit: contain;
}

.mfb-envelope-recipient {
    flex: 1 1 auto;
    min-width: 200px;
    max-width: 350px;
}

.mfb-envelope-label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: #64748b;
    margin-bottom: 0.75rem;
    font-weight: 700;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid #e2e8f0;
}

.mfb-envelope-label i {
    font-size: 0.875rem;
}

.mfb-envelope-address {
    font-size: 0.9375rem;
    line-height: 1.7;
    color: #1e293b;
}

.mfb-envelope-address strong {
    font-size: 1.0625rem;
    color: #0f172a;
    display: block;
    margin-bottom: 0.25rem;
}

.mfb-envelope-parcel {
    flex: 0 0 auto;
    min-width: 150px;
    text-align: center;
    padding-left: 3rem;
    border-left: 2px dashed #cbd5e1;
    display: flex;
    flex-direction: column;
    justify-content: center;
}

.mfb-envelope-parcel .mfb-parcel-dimensions {
    font-size: 1.375rem;
    font-weight: 700;
    color: #1e293b;
    margin-top: 0.5rem;
}

.mfb-envelope-parcel .mfb-parcel-weight {
    font-size: 1rem;
    color: #64748b;
    margin-top: 0.375rem;
    font-weight: 500;
}

/* ========================================
   MFB Status Timeline (Horizontal)
   ======================================== */

.mfb-status-timeline {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    padding: 1rem 0;
    margin: 1rem 0;
    position: relative;
}

.mfb-status-timeline::before {
    content: '';
    position: absolute;
    top: 1.75rem;
    left: 2rem;
    right: 2rem;
    height: 3px;
    background: #e2e8f0;
    z-index: 0;
}

.mfb-timeline-step {
    display: flex;
    flex-direction: column;
    align-items: center;
    flex: 1;
    position: relative;
    z-index: 1;
}

.mfb-timeline-icon {
    width: 2.5rem;
    height: 2.5rem;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    margin-bottom: 0.5rem;
    transition: all 0.3s ease;
}

/* Step states */
.mfb-timeline-step.completed .mfb-timeline-icon {
    background: #22c55e;
    color: white;
    box-shadow: 0 2px 8px rgba(34, 197, 94, 0.4);
}

.mfb-timeline-step.current .mfb-timeline-icon {
    background: #3b82f6;
    color: white;
    box-shadow: 0 2px 12px rgba(59, 130, 246, 0.5);
    animation: pulse 2s infinite;
}

.mfb-timeline-step.pending .mfb-timeline-icon {
    background: #f1f5f9;
    color: #94a3b8;
    border: 2px solid #e2e8f0;
}

.mfb-timeline-step.cancelled .mfb-timeline-icon {
    background: #ef4444;
    color: white;
    box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}

.mfb-timeline-label {
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.03em;
    text-align: center;
}

.mfb-timeline-step.completed .mfb-timeline-label {
    color: #22c55e;
}

.mfb-timeline-step.current .mfb-timeline-label {
    color: #3b82f6;
}

.mfb-timeline-step.pending .mfb-timeline-label {
    color: #94a3b8;
}

.mfb-timeline-step.cancelled .mfb-timeline-label {
    color: #ef4444;
}

.mfb-timeline-date {
    font-size: 0.6875rem;
    color: #64748b;
    margin-top: 0.25rem;
}

/* Progress line overlay */
.mfb-timeline-progress {
    position: absolute;
    top: 1.75rem;
    left: 2rem;
    height: 3px;
    background: #22c55e;
    z-index: 0;
    transition: width 0.5s ease;
}

/* ========================================
   MFB Action Buttons (Side Panel)
   ======================================== */

.mfb-actions-panel {
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    padding: 1.25rem;
    height: 100%;
}

.mfb-actions-panel .mfb-actions-title {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: #64748b;
    font-weight: 700;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid #e2e8f0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.mfb-actions-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.mfb-action-btn {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.875rem 1rem;
    border-radius: 8px;
    font-size: 0.875rem;
    font-weight: 600;
    text-align: left;
    transition: all 0.2s ease;
    border: 1px solid transparent;
    cursor: pointer;
    width: 100%;
}

.mfb-action-btn i {
    font-size: 1rem;
    width: 1.25rem;
    text-align: center;
    flex-shrink: 0;
}

.mfb-action-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

/* Primary action - Book/Validate */
.mfb-action-btn.btn-primary {
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    color: white;
    border-color: #2563eb;
}

.mfb-action-btn.btn-primary:hover {
    background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
}

/* Success action - Ship */
.mfb-action-btn.btn-success {
    background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
    color: white;
    border-color: #16a34a;
}

.mfb-action-btn.btn-success:hover {
    background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
}

/* Default action - Download, Update */
.mfb-action-btn.btn-default {
    background: white;
    color: #374151;
    border-color: #d1d5db;
}

.mfb-action-btn.btn-default:hover {
    background: #f9fafb;
    border-color: #9ca3af;
}

/* Warning action - Return */
.mfb-action-btn.btn-warning {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    color: white;
    border-color: #d97706;
}

.mfb-action-btn.btn-warning:hover {
    background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
}

/* Danger action - Cancel */
.mfb-action-btn.btn-danger {
    background: white;
    color: #dc2626;
    border-color: #fecaca;
}

.mfb-action-btn.btn-danger:hover {
    background: #fef2f2;
    border-color: #f87171;
}

/* Deprecated bottom bar - keep for compatibility */
.mfb-actions-bar {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    padding: 1rem 0;
    margin-top: 1rem;
    border-top: 1px solid #e2e8f0;
}

.mfb-actions-bar .btn {
    flex: 1 1 auto;
    min-width: 140px;
}

/* ========================================
   MFB History Panel (Unified Style)
   ======================================== */

.mfb-history-panel {
    background: #fff;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    overflow: hidden;
}

.mfb-history-panel .panel-heading {
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    border-bottom: 1px solid #e2e8f0;
    padding: 0.875rem 1.25rem;
}

.mfb-history-panel .panel-title {
    font-size: 0.9375rem;
    font-weight: 600;
    color: #1e293b;
    margin: 0;
}

.mfb-history-panel .panel-body {
    padding: 1rem 1.25rem;
}

.mfb-history-list {
    display: flex;
    flex-direction: column;
    gap: 0;
}

.mfb-history-item {
    display: flex;
    align-items: flex-start;
    gap: 1rem;
    padding: 0.75rem 0;
    border-bottom: 1px solid #f1f5f9;
}

.mfb-history-item:last-child {
    border-bottom: none;
    padding-bottom: 0;
}

.mfb-history-item:first-child {
    padding-top: 0;
}

.mfb-history-icon {
    width: 2rem;
    height: 2rem;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    flex-shrink: 0;
    background: #f1f5f9;
    color: #64748b;
}

.mfb-history-item.status-delivered .mfb-history-icon {
    background: #dcfce7;
    color: #22c55e;
}

.mfb-history-item.status-shipped .mfb-history-icon {
    background: #dbeafe;
    color: #3b82f6;
}

.mfb-history-item.status-booked .mfb-history-icon {
    background: #e0f2fe;
    color: #0ea5e9;
}

.mfb-history-item.status-created .mfb-history-icon {
    background: #f3e8ff;
    color: #a855f7;
}

.mfb-history-item.status-cancelled .mfb-history-icon {
    background: #fee2e2;
    color: #ef4444;
}

.mfb-history-item.status-change .mfb-history-icon {
    background: #fef3c7;
    color: #f59e0b;
}

.mfb-history-content {
    flex: 1;
    min-width: 0;
}

.mfb-history-title {
    font-weight: 600;
    font-size: 0.875rem;
    color: #1e293b;
    margin-bottom: 0.125rem;
}

.mfb-history-description {
    font-size: 0.8125rem;
    color: #64748b;
}

.mfb-history-date {
    font-size: 0.75rem;
    color: #94a3b8;
    white-space: nowrap;
}
</style>
