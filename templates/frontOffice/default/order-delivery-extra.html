{* MyFlyingBox - Shipping Options & Relay Point Selection *}
{* This hook is rendered inside a <tbody>, so we must use <tr><td> wrapper *}

{if $offers|@count > 0}
<tr id="myflyingbox-options-row" class="mfb-options-row">
    <td colspan="3" style="padding: 0; border: none;">
        {* ============================================
           SKELETON LOADER - Visible pendant le chargement
           ============================================ *}
        <div id="mfb-skeleton" class="mfb-container mfb-skeleton-container">
            {* Header skeleton *}
            <div class="mfb-header">
                <div class="mfb-skeleton-icon"></div>
                <div class="mfb-skeleton-header-text">
                    <div class="mfb-skeleton-line mfb-skeleton-title"></div>
                    <div class="mfb-skeleton-line mfb-skeleton-subtitle"></div>
                </div>
            </div>

            {* Offers skeleton (3 fake cards) *}
            <div class="mfb-offers-grid">
                <div class="mfb-skeleton-card">
                    <div class="mfb-skeleton-circle"></div>
                    <div class="mfb-skeleton-badge"></div>
                    <div class="mfb-skeleton-content">
                        <div class="mfb-skeleton-line" style="width: 70%"></div>
                        <div class="mfb-skeleton-line" style="width: 40%"></div>
                    </div>
                    <div class="mfb-skeleton-time"></div>
                    <div class="mfb-skeleton-price"></div>
                </div>
                <div class="mfb-skeleton-card">
                    <div class="mfb-skeleton-circle"></div>
                    <div class="mfb-skeleton-badge"></div>
                    <div class="mfb-skeleton-content">
                        <div class="mfb-skeleton-line" style="width: 55%"></div>
                        <div class="mfb-skeleton-line" style="width: 35%"></div>
                    </div>
                    <div class="mfb-skeleton-time"></div>
                    <div class="mfb-skeleton-price"></div>
                </div>
                <div class="mfb-skeleton-card">
                    <div class="mfb-skeleton-circle"></div>
                    <div class="mfb-skeleton-badge"></div>
                    <div class="mfb-skeleton-content">
                        <div class="mfb-skeleton-line" style="width: 65%"></div>
                        <div class="mfb-skeleton-line" style="width: 45%"></div>
                    </div>
                    <div class="mfb-skeleton-time"></div>
                    <div class="mfb-skeleton-price"></div>
                </div>
            </div>
        </div>

        {* ============================================
           REAL CONTENT - Hidden initially, revealed by JS
           ============================================ *}
        <div id="myflyingbox-options" class="mfb-container mfb-content-hidden">
            {* Header *}
            <div class="mfb-header">
                <div class="mfb-header-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="1" y="3" width="15" height="13"></rect>
                        <polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon>
                        <circle cx="5.5" cy="18.5" r="2.5"></circle>
                        <circle cx="18.5" cy="18.5" r="2.5"></circle>
                    </svg>
                </div>
                <div class="mfb-header-text">
                    <h3>{intl l="Choisissez votre livraison" d="myflyingbox"}</h3>
                    <p>{$offers|@count} {intl l="options disponibles" d="myflyingbox"}</p>
                </div>
            </div>

            {* Offers grid *}
            <div class="mfb-offers-grid">
                {foreach $offers as $offer}
                <label class="mfb-offer-card{if $offer.relay_delivery} is-relay{/if}" data-offer-id="{$offer.id}">
                    <input type="radio"
                           name="mfb_offer_id"
                           value="{$offer.id}"
                           data-service-id="{$offer.service_id}"
                           data-relay-delivery="{if $offer.relay_delivery}1{else}0{/if}"
                           data-price="{$offer.price}"
                           data-api-uuid="{$offer.api_offer_uuid}"
                           class="mfb-offer-radio">

                    {* Selection indicator *}
                    <div class="mfb-check-indicator">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                    </div>

                    {* Carrier logo/badge *}
                    <div class="mfb-carrier-badge" data-carrier="{$offer.carrier_code|lower}">
                        <span class="mfb-carrier-code">{$offer.carrier_code|upper}</span>
                    </div>

                    {* Service info *}
                    <div class="mfb-service-info">
                        <span class="mfb-service-name">{$offer.service_name}</span>
                        {if $offer.relay_delivery}
                        <span class="mfb-badge-relay">
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                            </svg>
                            {intl l="Point Relais" d="myflyingbox"}
                        </span>
                        {/if}
                    </div>

                    {* Delivery time *}
                    {if $offer.delivery_days}
                    <div class="mfb-delivery-time">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <polyline points="12 6 12 12 16 14"></polyline>
                        </svg>
                        <span>{$offer.delivery_days}h</span>
                    </div>
                    {/if}

                    {* Price *}
                    <div class="mfb-price">
                        <span class="mfb-price-value">{$offer.price_formatted}</span>
                    </div>
                </label>
                {/foreach}
            </div>

            {* Relay point selection *}
            {if $has_relay_services}
            <div id="myflyingbox-relay-container" class="mfb-relay-section" style="display: none;">
                <div class="mfb-relay-header">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                        <circle cx="12" cy="10" r="3"></circle>
                    </svg>
                    <h4>{intl l="Sélectionnez votre point relais" d="myflyingbox"}</h4>
                </div>

                {* Selected relay display *}
                <div id="mfb-selected-relay" class="mfb-selected-relay" style="{if !$selected_relay}display: none;{/if}">
                    <div class="mfb-selected-relay-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                            <polyline points="22 4 12 14.01 9 11.01"></polyline>
                        </svg>
                    </div>
                    <div class="mfb-selected-relay-info">
                        <span class="mfb-selected-relay-label">{intl l="Point relais sélectionné" d="myflyingbox"}</span>
                        <div id="mfb-relay-info">
                            {if $selected_relay}
                            <strong>{$selected_relay.name}</strong><br>
                            {$selected_relay.street}<br>
                            {$selected_relay.postal_code} {$selected_relay.city}
                            {/if}
                        </div>
                    </div>
                    <button type="button" id="mfb-change-relay" class="mfb-btn mfb-btn-outline">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                        </svg>
                        {intl l="Modifier" d="myflyingbox"}
                    </button>
                </div>

                {* Search form *}
                <div id="mfb-relay-search" class="mfb-relay-search" style="{if $selected_relay}display: none;{/if}">
                    <div class="mfb-search-box">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="11" cy="11" r="8"></circle>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                        </svg>
                        <input type="text" id="mfb-search-location"
                               placeholder="{intl l='Entrez une ville ou un code postal...' d='myflyingbox'}">
                        <button type="button" id="mfb-search-btn" class="mfb-btn mfb-btn-primary">
                            {intl l="Rechercher" d="myflyingbox"}
                        </button>
                    </div>

                    {* Map container *}
                    <div id="mfb-map-container" class="mfb-map-container" style="display: none;">
                        <div id="mfb-map"></div>
                    </div>

                    {* Results list *}
                    <div id="mfb-relay-list" class="mfb-relay-list"></div>
                </div>

                {* Hidden input *}
                <input type="hidden" name="mfb_relay_code" id="mfb-relay-code" value="{if $selected_relay}{$selected_relay.code}{/if}">
            </div>
            {/if}
        </div>

<style>
/* ============================================
   MyFlyingBox Modern Delivery Selector
   ============================================ */

/* ============================================
   SKELETON LOADER STYLES
   ============================================ */

/* Shimmer animation */
@keyframes mfb-shimmer {
    0% { background-position: -200% 0; }
    100% { background-position: 200% 0; }
}

/* Fade animations */
@keyframes mfb-fade-out {
    from { opacity: 1; }
    to { opacity: 0; }
}

@keyframes mfb-fade-in {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Skeleton container */
.mfb-skeleton-container {
    pointer-events: none;
}

.mfb-skeleton-container.mfb-hidden {
    display: none;
}

/* Content initially hidden */
.mfb-content-hidden {
    opacity: 0;
    display: none;
}

.mfb-content-visible {
    display: block;
    animation: mfb-fade-in 0.4s ease-out forwards;
}

/* Skeleton base styles */
.mfb-skeleton-line,
.mfb-skeleton-icon,
.mfb-skeleton-circle,
.mfb-skeleton-badge,
.mfb-skeleton-time,
.mfb-skeleton-price {
    background: linear-gradient(90deg, #e2e8f0 25%, #f1f5f9 50%, #e2e8f0 75%);
    background-size: 200% 100%;
    animation: mfb-shimmer 1.5s ease-in-out infinite;
    border-radius: 8px;
}

.mfb-skeleton-header-text {
    display: flex;
    flex-direction: column;
    gap: 8px;
    flex: 1;
}

.mfb-skeleton-icon {
    width: 56px;
    height: 56px;
    border-radius: 14px;
    flex-shrink: 0;
}

.mfb-skeleton-title {
    height: 24px;
    width: 220px;
}

.mfb-skeleton-subtitle {
    height: 16px;
    width: 140px;
}

.mfb-skeleton-card {
    display: flex;
    align-items: center;
    gap: 20px;
    padding: 20px 24px;
    background: white;
    border: 2px solid #e2e8f0;
    border-radius: 14px;
}

.mfb-skeleton-circle {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    flex-shrink: 0;
}

.mfb-skeleton-badge {
    width: 100px;
    height: 40px;
    flex-shrink: 0;
}

.mfb-skeleton-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 10px;
    min-width: 0;
}

.mfb-skeleton-content .mfb-skeleton-line {
    height: 18px;
}

.mfb-skeleton-time {
    width: 80px;
    height: 42px;
    border-radius: 10px;
    flex-shrink: 0;
}

.mfb-skeleton-price {
    width: 90px;
    height: 32px;
    flex-shrink: 0;
}

/* Responsive skeleton */
@media (max-width: 768px) {
    .mfb-skeleton-card {
        flex-wrap: wrap;
        padding: 16px;
        gap: 12px;
    }

    .mfb-skeleton-content {
        flex-basis: 100%;
        order: 2;
    }

    .mfb-skeleton-time {
        order: 3;
    }

    .mfb-skeleton-price {
        order: 4;
        margin-left: auto;
    }

    .mfb-skeleton-circle {
        order: -1;
    }

    .mfb-skeleton-title {
        width: 160px;
    }

    .mfb-skeleton-subtitle {
        width: 100px;
    }
}

/* ============================================
   END SKELETON LOADER STYLES
   ============================================ */

.mfb-container {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    border-radius: 16px;
    padding: 24px;
    margin: 16px 0;
}

/* Header */
.mfb-header {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 24px;
    padding-bottom: 20px;
    border-bottom: 2px solid rgba(0,0,0,0.06);
}

.mfb-header-icon {
    width: 56px;
    height: 56px;
    background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
    border-radius: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
}

.mfb-header-text h3 {
    margin: 0 0 4px 0;
    font-size: 1.5rem;
    font-weight: 700;
    color: #1e293b;
    letter-spacing: -0.02em;
}

.mfb-header-text p {
    margin: 0;
    font-size: 0.95rem;
    color: #64748b;
}

/* Offers List */
.mfb-offers-grid {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

/* Offer Card - Horizontal Layout */
.mfb-offer-card {
    position: relative;
    display: flex;
    flex-direction: row;
    align-items: center;
    padding: 20px 24px;
    background: white;
    border: 2px solid #e2e8f0;
    border-radius: 14px;
    cursor: pointer;
    transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    overflow: hidden;
    gap: 20px;
}

.mfb-offer-card:hover {
    border-color: #93c5fd;
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(59, 130, 246, 0.15);
}

.mfb-offer-card.selected {
    border-color: #22c55e !important;
    background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%) !important;
    box-shadow: 0 8px 25px rgba(34, 197, 94, 0.25) !important;
}

/* Relay services have a subtle indicator instead of border */
.mfb-offer-card.is-relay {
    /* No special border - handled by badge */
}

/* Hidden radio */
.mfb-offer-radio {
    position: absolute;
    opacity: 0;
    width: 0;
    height: 0;
}

/* Check indicator */
.mfb-check-indicator {
    width: 28px;
    height: 28px;
    background: #e2e8f0;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: transparent;
    transition: all 0.2s ease;
    flex-shrink: 0;
    order: -1;
}

.mfb-offer-card.selected .mfb-check-indicator {
    background: #22c55e !important;
    color: white !important;
    box-shadow: 0 2px 8px rgba(34, 197, 94, 0.4) !important;
}

/* Carrier Badge */
.mfb-carrier-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 10px 18px;
    background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
    border-radius: 8px;
    flex-shrink: 0;
    min-width: 100px;
}

.mfb-carrier-badge[data-carrier="colissimo"] {
    background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
}

.mfb-carrier-badge[data-carrier="chronopost"] {
    background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
}

.mfb-carrier-badge[data-carrier="mondial_relay"] {
    background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
}

.mfb-carrier-badge[data-carrier="dhl"] {
    background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
}

.mfb-carrier-badge[data-carrier="fedex"] {
    background: linear-gradient(135deg, #7c3aed 0%, #8b5cf6 100%);
}

.mfb-carrier-badge[data-carrier="ups"] {
    background: linear-gradient(135deg, #78350f 0%, #92400e 100%);
}

.mfb-carrier-badge[data-carrier="dpd"] {
    background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
}

.mfb-carrier-code {
    font-size: 0.85rem;
    font-weight: 800;
    color: white;
    letter-spacing: 0.05em;
    text-transform: uppercase;
}

/* Service Info */
.mfb-service-info {
    display: flex;
    flex-direction: column;
    gap: 6px;
    flex: 1;
    min-width: 0;
}

.mfb-service-name {
    font-size: 1.1rem;
    font-weight: 600;
    color: #1e293b;
    line-height: 1.3;
}

.mfb-badge-relay {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 5px 10px;
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    color: #92400e;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    align-self: flex-start;
}

/* Delivery Time */
.mfb-delivery-time {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 16px;
    background: #f1f5f9;
    border-radius: 10px;
    color: #475569;
    font-size: 0.95rem;
    font-weight: 500;
    flex-shrink: 0;
}

.mfb-delivery-time svg {
    color: #3b82f6;
    flex-shrink: 0;
}

/* Price */
.mfb-price {
    flex-shrink: 0;
    text-align: right;
    min-width: 100px;
}

.mfb-price-value {
    font-size: 1.4rem;
    font-weight: 800;
    color: #059669;
    letter-spacing: -0.02em;
}

/* ============================================
   Relay Section
   ============================================ */

.mfb-relay-section {
    margin-top: 24px;
    padding-top: 24px;
    border-top: 2px solid rgba(0,0,0,0.06);
}

.mfb-relay-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 20px;
    color: #f59e0b;
}

.mfb-relay-header h4 {
    margin: 0;
    font-size: 1.25rem;
    font-weight: 700;
    color: #1e293b;
}

/* Selected Relay */
.mfb-selected-relay {
    display: flex;
    align-items: center;
    gap: 20px;
    padding: 20px 24px;
    background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
    border: 2px solid #34d399;
    border-radius: 14px;
}

.mfb-selected-relay-icon {
    width: 56px;
    height: 56px;
    background: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #22c55e;
    box-shadow: 0 2px 8px rgba(34, 197, 94, 0.2);
    flex-shrink: 0;
}

.mfb-selected-relay-info {
    flex: 1;
}

.mfb-selected-relay-label {
    display: block;
    font-size: 0.85rem;
    font-weight: 600;
    color: #059669;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 6px;
}

#mfb-relay-info {
    font-size: 1.05rem;
    color: #1e293b;
    line-height: 1.5;
}

#mfb-relay-info strong {
    font-weight: 700;
    display: block;
    margin-bottom: 4px;
}

/* Search Box */
.mfb-search-box {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    background: white;
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    transition: all 0.2s ease;
}

.mfb-search-box:focus-within {
    border-color: #3b82f6;
    box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
}

.mfb-search-box svg {
    color: #94a3b8;
    flex-shrink: 0;
}

.mfb-search-box input {
    flex: 1;
    border: none;
    outline: none;
    font-size: 1.05rem;
    color: #1e293b;
    background: transparent;
}

.mfb-search-box input::placeholder {
    color: #94a3b8;
}

/* Buttons */
.mfb-btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 12px 20px;
    font-size: 0.95rem;
    font-weight: 600;
    border-radius: 10px;
    border: none;
    cursor: pointer;
    transition: all 0.2s ease;
    white-space: nowrap;
}

.mfb-btn-primary {
    background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
    color: white;
    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
}

.mfb-btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
}

.mfb-btn-outline {
    background: white;
    color: #3b82f6;
    border: 2px solid #3b82f6;
}

.mfb-btn-outline:hover {
    background: #eff6ff;
}

/* Map */
.mfb-map-container {
    margin-top: 20px;
    border-radius: 14px;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

#mfb-map {
    height: 350px;
    width: 100%;
}

/* Relay List */
.mfb-relay-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
    gap: 12px;
    max-height: 400px;
    overflow-y: auto;
    margin-top: 20px;
    padding: 4px;
}

.mfb-relay-list .mfb-loading {
    grid-column: 1 / -1;
}

.mfb-relay-item {
    padding: 18px;
    background: white;
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.mfb-relay-item:hover {
    border-color: #f59e0b;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(245, 158, 11, 0.15);
}

.mfb-relay-item.selected {
    border-color: #22c55e;
    background: #f0fdf4;
}

.mfb-relay-item .relay-name {
    font-size: 1.05rem;
    font-weight: 700;
    color: #1e293b;
    margin-bottom: 8px;
}

.mfb-relay-item .relay-address {
    font-size: 0.95rem;
    color: #64748b;
    line-height: 1.5;
}

.mfb-relay-item .relay-distance {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    margin-top: 10px;
    padding: 6px 12px;
    background: #eff6ff;
    color: #2563eb;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
}

/* Loading */
.mfb-loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    width: 100%;
    padding: 48px 24px;
    color: #64748b;
    font-size: 1rem;
    text-align: center;
    box-sizing: border-box;
}

.mfb-loading::before {
    content: '';
    width: 40px;
    height: 40px;
    margin-bottom: 16px;
    border: 4px solid #e2e8f0;
    border-top-color: #3b82f6;
    border-radius: 50%;
    animation: mfb-spin 0.8s linear infinite;
}

@keyframes mfb-spin {
    to { transform: rotate(360deg); }
}

/* Responsive */
@media (max-width: 768px) {
    .mfb-container {
        padding: 16px;
        border-radius: 12px;
    }

    .mfb-header {
        flex-direction: column;
        text-align: center;
    }

    .mfb-header-text h3 {
        font-size: 1.25rem;
    }

    .mfb-offer-card {
        flex-wrap: wrap;
        padding: 16px;
        gap: 12px;
    }

    .mfb-carrier-badge {
        min-width: auto;
    }

    .mfb-service-info {
        flex-basis: 100%;
        order: 2;
    }

    .mfb-delivery-time {
        flex-basis: auto;
        order: 3;
    }

    .mfb-price {
        order: 4;
        margin-left: auto;
    }

    .mfb-check-indicator {
        order: -1;
    }

    .mfb-selected-relay {
        flex-direction: column;
        text-align: center;
    }

    .mfb-search-box {
        flex-wrap: wrap;
    }

    .mfb-search-box input {
        width: 100%;
        order: 1;
    }

    .mfb-search-box svg {
        display: none;
    }

    .mfb-search-box .mfb-btn {
        width: 100%;
        justify-content: center;
        order: 2;
        margin-top: 8px;
    }

    .mfb-relay-list {
        grid-template-columns: 1fr;
    }
}
</style>

<script>
(function() {
    "use strict";

    var googleMapsApiKey = "{$google_maps_api_key|default:''}";
    var cartId = parseInt("{$cart_id|default:0}", 10);
    var selectedOfferId = "{$selected_offer_id|default:''}";

    console.log('MFB: Script loaded, cartId=' + cartId + ', selectedOfferId=' + selectedOfferId);

    /**
     * Transition from skeleton loader to real content
     */
    function transitionSkeletonToContent() {
        var skeleton = document.getElementById('mfb-skeleton');
        var content = document.getElementById('myflyingbox-options');

        if (!skeleton || !content) {
            console.log('MFB: Skeleton or content not found');
            return;
        }

        console.log('MFB: Starting skeleton to content transition');

        // Small delay to ensure skeleton is visible (better UX perception)
        setTimeout(function() {
            // Fade out skeleton
            skeleton.style.animation = 'mfb-fade-out 0.3s ease-out forwards';

            // After skeleton fade-out, show content
            setTimeout(function() {
                skeleton.classList.add('mfb-hidden');
                content.classList.remove('mfb-content-hidden');
                content.classList.add('mfb-content-visible');
                console.log('MFB: Transition complete');
            }, 300);
        }, 150);
    }

    function initMFB() {
        console.log('MFB: Initializing...');

        // Start skeleton to content transition
        transitionSkeletonToContent();

        var optionsContainer = document.getElementById('myflyingbox-options');
        console.log('MFB: optionsContainer =', optionsContainer);
        if (!optionsContainer) {
            console.log('MFB: No options container found, exiting');
            return;
        }

        var relayContainer = document.getElementById('myflyingbox-relay-container');
        var searchContainer = document.getElementById('mfb-relay-search');
        var selectedRelayDiv = document.getElementById('mfb-selected-relay');
        var relayInfoDiv = document.getElementById('mfb-relay-info');
        var searchInput = document.getElementById('mfb-search-location');
        var searchBtn = document.getElementById('mfb-search-btn');
        var changeBtn = document.getElementById('mfb-change-relay');
        var relayList = document.getElementById('mfb-relay-list');
        var relayCodeInput = document.getElementById('mfb-relay-code');
        var mapContainer = document.getElementById('mfb-map-container');

        var map = null;
        var markers = [];
        var currentOfferUuid = null;

    // Handle offer selection
    function selectOffer(radio) {
        if (!radio) {
            console.log('MFB: No radio found');
            return;
        }

        console.log('MFB: Selecting offer', radio.value);

        // Check the radio
        radio.checked = true;

        // Update visual selection - remove from all first
        var allCards = document.querySelectorAll('.mfb-offer-card');
        for (var i = 0; i < allCards.length; i++) {
            var item = allCards[i];
            item.classList.remove('selected');
            // Reset inline styles
            item.style.borderColor = '';
            item.style.background = '';
            item.style.boxShadow = '';
            // Reset check indicator
            var chk = item.querySelector('.mfb-check-indicator');
            if (chk) {
                chk.style.background = '';
                chk.style.color = '';
            }
        }

        // Add to current
        var card = radio.closest('.mfb-offer-card');
        card.classList.add('selected');
        // Apply inline styles - GREEN theme
        card.style.borderColor = '#22c55e';
        card.style.background = 'linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%)';
        card.style.boxShadow = '0 8px 25px rgba(34, 197, 94, 0.25)';

        // Style the check indicator
        var checkIndicator = card.querySelector('.mfb-check-indicator');
        if (checkIndicator) {
            checkIndicator.style.background = '#22c55e';
            checkIndicator.style.color = 'white';
        }

        console.log('MFB: Selection applied to card');

        // Save selection to server
        saveOfferSelection(radio.value);

        // Check if relay delivery
        var isRelay = radio.getAttribute('data-relay-delivery') === '1';
        currentOfferUuid = radio.getAttribute('data-api-uuid');

        if (relayContainer) {
            if (isRelay) {
                relayContainer.style.display = 'block';
                if (!relayCodeInput.value) {
                    selectedRelayDiv.style.display = 'none';
                    searchContainer.style.display = 'block';
                }
            } else {
                relayContainer.style.display = 'none';
                relayCodeInput.value = '';
            }
        }
    }

    // Add click handler to cards
    var offerCards = document.querySelectorAll('.mfb-offer-card');
    console.log('MFB: Found ' + offerCards.length + ' offer cards');

    for (var j = 0; j < offerCards.length; j++) {
        offerCards[j].addEventListener('click', function(e) {
            console.log('MFB: Card clicked');
            var radio = this.querySelector('.mfb-offer-radio');
            selectOffer(radio);
        });
    }

    // Also handle radio change event
    var radios = document.querySelectorAll('.mfb-offer-radio');
    for (var k = 0; k < radios.length; k++) {
        radios[k].addEventListener('change', function() {
            selectOffer(this);
        });
    }

    // Save offer selection to server
    function saveOfferSelection(offerId) {
        fetch('/myflyingbox/offer/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ cart_id: cartId, offer_id: offerId })
        }).catch(function(error) {
            console.error('Error saving offer:', error);
        });
    }

    // Initial check for selected offer - ensure only ONE is selected
    console.log('MFB: Initializing delivery selector');

    // First, clear all selections
    var cardsToReset = document.querySelectorAll('.mfb-offer-card');
    for (var m = 0; m < cardsToReset.length; m++) {
        cardsToReset[m].classList.remove('selected');
    }

    // Find the radio to select (previously selected or first one)
    var radioToSelect = null;

    // Try to find previously selected offer
    if (selectedOfferId) {
        radioToSelect = document.querySelector('.mfb-offer-radio[value="' + selectedOfferId + '"]');
        console.log('MFB: Found previously selected offer:', radioToSelect);
    }

    // Fallback to first radio if no previous selection
    if (!radioToSelect) {
        radioToSelect = document.querySelector('.mfb-offer-radio');
        console.log('MFB: Using first radio as default:', radioToSelect);
    }

    if (radioToSelect) {
        // Apply selection
        selectOffer(radioToSelect);
        console.log('MFB: Initial selection applied');
    } else {
        console.log('MFB: No radio buttons found!');
    }

    // Search handlers
    if (searchBtn) {
        searchBtn.addEventListener('click', function() {
            var query = searchInput.value.trim();
            if (query.length < 2) {
                alert('{intl l="Veuillez saisir au moins 2 caractères" d="myflyingbox" js=1}');
                return;
            }
            searchRelayPoints(query);
        });
    }

    if (searchInput) {
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                searchBtn.click();
            }
        });
    }

    if (changeBtn) {
        changeBtn.addEventListener('click', function() {
            selectedRelayDiv.style.display = 'none';
            searchContainer.style.display = 'block';
        });
    }

    function searchRelayPoints(query) {
        relayList.innerHTML = '<div class="mfb-loading">{intl l="Recherche en cours..." d="myflyingbox" js=1}</div>';

        fetch('/myflyingbox/relay-points?query=' + encodeURIComponent(query) + '&cart_id=' + cartId)
            .then(function(response) { return response.json(); })
            .then(function(data) {
                if (data.success && data.relays && data.relays.length > 0) {
                    displayRelayPoints(data.relays);
                } else {
                    var errorMsg = data.message || '{intl l="Aucun point relais trouvé" d="myflyingbox" js=1}';
                    relayList.innerHTML = '<div style="padding: 24px; text-align: center; color: #64748b; background: #f8fafc; border-radius: 12px;">' +
                        '<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin: 0 auto 12px; display: block; color: #94a3b8;"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>' +
                        '<p style="margin: 0 0 12px; font-weight: 600; color: #475569;">{intl l="Recherche de points relais indisponible" d="myflyingbox" js=1}</p>' +
                        '<p style="margin: 0; font-size: 0.9rem; color: #64748b;">{intl l="Le point relais sera sélectionné lors de la préparation de votre commande." d="myflyingbox" js=1}</p>' +
                        '</div>';
                    if (mapContainer) mapContainer.style.display = 'none';
                }
            })
            .catch(function(error) {
                console.error('Error:', error);
                relayList.innerHTML = '<div style="padding: 24px; text-align: center; color: #64748b; background: #f8fafc; border-radius: 12px;">' +
                    '<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin: 0 auto 12px; display: block; color: #94a3b8;"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>' +
                    '<p style="margin: 0 0 12px; font-weight: 600; color: #475569;">{intl l="Recherche de points relais indisponible" d="myflyingbox" js=1}</p>' +
                    '<p style="margin: 0; font-size: 0.9rem; color: #64748b;">{intl l="Le point relais sera sélectionné lors de la préparation de votre commande." d="myflyingbox" js=1}</p>' +
                    '</div>';
            });
    }

    function displayRelayPoints(relays) {
        relayList.innerHTML = '';

        relays.forEach(function(relay, index) {
            const item = document.createElement('div');
            item.className = 'mfb-relay-item';
            item.dataset.code = relay.code;

            let html = '<div class="relay-name">' + escapeHtml(relay.name) + '</div>';
            html += '<div class="relay-address">' + escapeHtml(relay.street) + '<br>' + escapeHtml(relay.postal_code) + ' ' + escapeHtml(relay.city) + '</div>';
            if (relay.distance) {
                html += '<div class="relay-distance"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg> ' + relay.distance + ' km</div>';
            }
            item.innerHTML = html;

            item.addEventListener('click', function() {
                selectRelay(relay);
            });

            relayList.appendChild(item);
        });

        if (googleMapsApiKey && relays.length > 0) {
            initMap(relays);
        }
    }

    function selectRelay(relay) {
        fetch('/myflyingbox/relay/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                cart_id: cartId,
                relay_code: relay.code,
                relay_name: relay.name,
                relay_street: relay.street,
                relay_city: relay.city,
                relay_postal_code: relay.postal_code,
                relay_country: relay.country || 'FR'
            })
        })
        .then(function(response) { return response.json(); })
        .then(function(data) {
            if (data.success) {
                relayCodeInput.value = relay.code;
                relayInfoDiv.innerHTML = '<strong>' + escapeHtml(relay.name) + '</strong><br>' +
                    escapeHtml(relay.street) + '<br>' +
                    escapeHtml(relay.postal_code) + ' ' + escapeHtml(relay.city);
                selectedRelayDiv.style.display = 'flex';
                searchContainer.style.display = 'none';
            } else {
                alert(data.message || '{intl l="Erreur lors de la sélection" d="myflyingbox" js=1}');
            }
        })
        .catch(function(error) {
            console.error('Error:', error);
            alert('{intl l="Erreur lors de la sélection" d="myflyingbox" js=1}');
        });
    }

    function initMap(relays) {
        if (!window.google || !window.google.maps) {
            const script = document.createElement('script');
            script.src = 'https://maps.googleapis.com/maps/api/js?key=' + googleMapsApiKey + '&callback=mfbInitMapCallback';
            script.async = true;
            window.mfbInitMapCallback = function() { createMap(relays); };
            window.mfbRelays = relays;
            document.head.appendChild(script);
        } else {
            createMap(relays);
        }
    }

    function createMap(relays) {
        if (!mapContainer) return;
        mapContainer.style.display = 'block';

        const bounds = new google.maps.LatLngBounds();
        map = new google.maps.Map(document.getElementById('mfb-map'), {
            zoom: 12,
            mapTypeControl: false,
            streetViewControl: false,
            styles: [{ featureType: 'poi', stylers: [{ visibility: 'off' }] }]
        });

        markers.forEach(function(m) { m.setMap(null); });
        markers = [];

        relays.forEach(function(relay, index) {
            if (relay.latitude && relay.longitude) {
                const position = new google.maps.LatLng(parseFloat(relay.latitude), parseFloat(relay.longitude));
                bounds.extend(position);

                const marker = new google.maps.Marker({
                    position: position,
                    map: map,
                    title: relay.name,
                    label: { text: String(index + 1), color: 'white', fontWeight: 'bold' },
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 14,
                        fillColor: '#f59e0b',
                        fillOpacity: 1,
                        strokeColor: '#ffffff',
                        strokeWeight: 3
                    }
                });

                marker.addListener('click', function() {
                    document.querySelectorAll('.mfb-relay-item').forEach(function(item) {
                        item.classList.remove('selected');
                        if (item.dataset.code === relay.code) {
                            item.classList.add('selected');
                            item.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                        }
                    });
                    selectRelay(relay);
                });

                markers.push(marker);
            }
        });

        if (markers.length > 0) {
            map.fitBounds(bounds);
        }
    }

    function escapeHtml(text) {
        if (!text) return '';
        var div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    } // end initMFB

    // Run immediately if DOM is ready, otherwise wait
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initMFB);
    } else {
        // DOM is already ready, run now
        console.log('MFB: DOM already ready, running immediately');
        initMFB();
    }
})(); // end IIFE

// Hide default module row
(function() {
    var optionsRow = document.getElementById('myflyingbox-options-row');
    if (optionsRow) {
        var prevRow = optionsRow.previousElementSibling;
        while (prevRow && prevRow.tagName !== 'TR') {
            prevRow = prevRow.previousElementSibling;
        }
        if (prevRow && prevRow.tagName === 'TR' && prevRow.id && prevRow.id.startsWith('delivery-module-')) {
            var moduleRadio = prevRow.querySelector('input[type="radio"]');
            if (moduleRadio) moduleRadio.checked = true;
            prevRow.style.display = 'none';
        }
    }
})();
</script>
    </td>
</tr>
{elseif $quote_id}
<tr class="mfb-no-offers-row">
    <td colspan="3" style="padding: 20px; border: none;">
        <div style="padding: 24px; background: #fef3c7; border: 2px solid #fbbf24; border-radius: 12px; text-align: center; color: #92400e; font-size: 1rem;">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: block; margin: 0 auto 12px;">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="8" x2="12" y2="12"></line>
                <line x1="12" y1="16" x2="12.01" y2="16"></line>
            </svg>
            {intl l="Aucune option de livraison disponible pour votre adresse." d="myflyingbox"}
        </div>
    </td>
</tr>
{/if}
